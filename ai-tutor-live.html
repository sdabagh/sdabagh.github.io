<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Statistics Tutor - Powered by Claude</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8F9FA;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 100%;
            height: 100%;
            margin: 0 auto;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2C5F7C 0%, #3A7CA5 100%);
            color: white;
            padding: 15px 20px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .api-status {
            padding: 8px 15px;
            background: #D4EDDA;
            border-bottom: 2px solid #28A745;
            font-size: 13px;
            text-align: center;
            flex-shrink: 0;
            color: #155724;
        }

        .api-status.error {
            background: #F8D7DA;
            border-color: #DC3545;
            color: #721C24;
        }

        .level-indicator {
            text-align: center;
            padding: 8px 10px;
            background: #FFF9E6;
            border-bottom: 2px solid #FFE082;
            font-size: 13px;
            flex-shrink: 0;
        }

        .level-badge {
            display: inline-block;
            padding: 3px 10px;
            background: #FFB020;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 5px;
            font-size: 12px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #FAFBFC;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 85%;
            line-height: 1.6;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .message-ai {
            background: #E7F3FF;
            border: 1px solid #90CAF9;
            margin-right: auto;
        }

        .message-user {
            background: #D97D54;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message-system {
            background: #FFF3CD;
            border: 1px solid #FFC107;
            margin: 0 auto;
            max-width: 90%;
            text-align: center;
            font-size: 12px;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .typing {
            padding: 10px 14px;
            background: #E0E0E0;
            border-radius: 8px;
            max-width: 120px;
            font-style: italic;
            color: #666;
            font-size: 13px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .input-area {
            padding: 12px 15px;
            border-top: 2px solid #E0E0E0;
            background: white;
            flex-shrink: 0;
        }

        .input-form {
            display: flex;
            gap: 8px;
        }

        .input-form input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #2C5F7C;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .input-form input:focus {
            outline: none;
            border-color: #3A7CA5;
            box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1);
        }

        .input-form button {
            padding: 10px 20px;
            background: #2C5F7C;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .input-form button:hover {
            background: #1A3A4D;
        }

        .input-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Scrollbar styling */
        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 18px; }
            .message { max-width: 95%; }
            .input-form input { font-size: 16px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Statistics Tutor</h1>
            <p>Live AI-Powered Adaptive Scaffolding with Claude</p>
        </div>

        <div id="api-status" class="api-status">
            ‚úÖ Connected to AI Tutor (Secure Backend)
        </div>

        <div class="level-indicator">
            Current Support Level: <span class="level-badge" id="level-display">Level 1 - Hints</span>
        </div>

        <div class="messages" id="messages">
            <div class="message message-ai">
                <strong>AI Tutor</strong>
Welcome! I'm your live AI statistics tutor powered by Claude. I can help you with:

‚Ä¢ Your specific homework problems with YOUR data
‚Ä¢ Quiz questions and exam preparation
‚Ä¢ Step-by-step solutions tailored to your question
‚Ä¢ Any statistics topic at any level

I provide adaptive scaffolding:
‚Ä¢ <strong>Level 1:</strong> Hints and guiding questions
‚Ä¢ <strong>Level 2:</strong> Step-by-step breakdowns
‚Ä¢ <strong>Level 3:</strong> Complete worked examples

I'll automatically adjust my support based on our conversation. Ask me anything about statistics!
            </div>
        </div>

        <div class="input-area">
            <form class="input-form" id="chat-form">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Ask me to help with your homework, explain a concept, or solve a problem..."
                    autocomplete="off"
                    required
                />
                <button type="submit" id="send-btn">Send</button>
            </form>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const WORKER_URL = 'https://stats-tutor-api.sofiadabagh383.workers.dev';

        // ===== STATE MANAGEMENT =====
        let currentLevel = 1;
        let attemptCount = 0;
        let conversationHistory = [];

        // ===== DOM ELEMENTS =====
        const apiStatus = document.getElementById('api-status');
        const messagesDiv = document.getElementById('messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const levelDisplay = document.getElementById('level-display');

        // ===== SCAFFOLDING LEVEL MANAGEMENT =====
        function updateLevel() {
            attemptCount++;

            // Escalate support based on number of questions
            if (attemptCount >= 4) {
                currentLevel = 3; // Full worked examples after 4+ questions
            } else if (attemptCount >= 2) {
                currentLevel = 2; // Guided steps after 2-3 questions
            }
            // else stays at level 1 (hints)

            const levelNames = {
                1: 'Level 1 - Hints',
                2: 'Level 2 - Guided Steps',
                3: 'Level 3 - Worked Examples'
            };

            levelDisplay.textContent = levelNames[currentLevel];

            // Log for research data collection
            console.log(`[SCAFFOLDING] Level updated to ${currentLevel} (total attempts: ${attemptCount})`);
        }

        // ===== CHAT UI FUNCTIONS =====
        function addMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;

            const label = role === 'user' ? 'You' : 'AI Tutor';
            messageDiv.innerHTML = `<strong>${label}</strong>${text}`;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-system';
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'typing';
            typing.id = 'typing-indicator';
            typing.textContent = 'AI is thinking...';
            messagesDiv.appendChild(typing);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function updateApiStatus(status, message) {
            if (status === 'error') {
                apiStatus.className = 'api-status error';
                apiStatus.textContent = '‚ùå ' + (message || 'Connection Error');
            } else {
                apiStatus.className = 'api-status';
                apiStatus.textContent = '‚úÖ Connected to AI Tutor (Secure Backend)';
            }
        }

        // ===== WORKER API INTEGRATION =====
        async function sendToWorker(userMessage) {
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: userMessage,
                    scaffoldingLevel: currentLevel
                })
            });

            if (!response.ok) {
                // Try to get error details, but handle cases where response body is empty or not JSON
                let errorMessage = `Worker request failed with status ${response.status}`;
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.error || errorJson.message || errorMessage;
                        } catch (e) {
                            // Response wasn't JSON, use the text as the error message
                            errorMessage = errorText;
                        }
                    }
                } catch (e) {
                    // Couldn't read response body, use default message
                    console.error('Error reading response:', e);
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            return data.response;
        }

        // ===== RESEARCH DATA LOGGING =====
        function logResearchData(eventType, data) {
            const logEntry = {
                eventType,
                timestamp: new Date().toISOString(),
                scaffoldingLevel: currentLevel,
                attemptCount,
                ...data
            };

            console.log('[RESEARCH LOG]', logEntry);

            // In production, send to your research database
            // Example: sendToFirestore(logEntry);
        }

        // ===== FORM SUBMISSION HANDLER =====
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const text = userInput.value.trim();
            if (!text) return;

            // Disable input
            sendBtn.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage('user', text);
            userInput.value = '';

            // Log interaction
            logResearchData('user_message', {
                message: text,
                messageLength: text.length
            });

            // Update scaffolding level
            updateLevel();

            // Show typing
            showTyping();

            try {
                // Call Cloudflare Worker (which calls Claude API)
                const aiResponse = await sendToWorker(text);

                // Hide typing and show response
                hideTyping();
                addMessage('ai', aiResponse);

                // Log AI response
                logResearchData('ai_response', {
                    responseLength: aiResponse.length,
                    scaffoldingLevel: currentLevel
                });

                // Track conversation
                conversationHistory.push(
                    { role: 'user', content: text, level: currentLevel },
                    { role: 'assistant', content: aiResponse, level: currentLevel }
                );

                // Update status to show connection is good
                updateApiStatus('connected');

            } catch (error) {
                hideTyping();
                console.error('API Error:', error);
                addSystemMessage('‚ùå Error: ' + error.message);
                updateApiStatus('error', error.message);

                logResearchData('api_error', {
                    error: error.message
                });
            }

            // Re-enable input
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        });

        // ===== START =====
        console.log('‚úÖ AI Statistics Tutor initialized');
        console.log('ü§ñ Using Claude via Cloudflare Worker proxy');
        console.log('üîí API key is secure (not exposed in browser)');
        console.log('üìä Research data logging active');
        console.log('üéØ Worker URL:', WORKER_URL);

        // Focus input on load
        userInput.focus();
    </script>

</body>
</html>
